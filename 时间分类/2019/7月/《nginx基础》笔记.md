# 《nginx基础》笔记

###### author:朱泽聪
###### createTime:2019/7/13

## 目录

* [nginx简介](#1,nginx简介)
* [nginx常用功能](2,nginx常用功能)
* [nginx环境搭建](3,nginx环境搭建)
* [常见问题分析](4,常见问题分析)

## 1,nginx简介

在部署了nginx的服务器中,其网络结构一般为: internet -> 防火墙 -> F5 -> nginx服务器 -> app服务器 -> DB。

### nginx主要优点:

* 1, 高并发连接 : 官方测试能够支撑5万并发连接, 在实际生产环境中跑到2~3万并发连接数
* 2, 内存消耗小 : 在3万并发连接下, 开启的10个nginx进程才消耗150M内存
* 3, 配置文件非常简单 : 风格跟程序一样通俗易懂
* 4, 成本低廉 : nginx为开源软件,开源免费使用
* 5, 支持Rewrite重写规则 : 能够根据域名, URL的不同, 将HTTP请求分到不同的后端服务器群组
* 6, 内置的健康检查功能 : 如果nginx Proxy后端的某台服务器出故障了,不会影响前端访问
* 7, 节省带宽 : 支持GZIP压缩, 可以添加浏览器本地缓存的Header头
* 8, 稳定性高 : 用于反向代理, qin机的概率微乎其微。

## 2,nginx常用功能

### 反向代理

###### 正向代理和方向代理的区别

* **正向代理** :
  * 架设在客户端和服务器之间
  * 代理内部网络对internet的连接请求
  * 客户机必须指定代理服务器, 并将本来要发送到web服务器上的http请求发送到代理服务器中
* **反向代理** :
  * 架设在服务器端
  * 将客户端请求转发给内部网络上的目标服务器
  * 将从服务器上得到的结果返回给internet上请求连接的客户端
  * 代理服务器和目标服务器一起对外表现为一个服务器

``` js
// 反向代理基础配置
upstream rtpserver {
    // 配置应用服务器
    server 21.96.51.223:8080;
}
server {
    location / {
        // 配置对外地址
        proxy_pass http://rtpserver;
    }
}
```

### 负载均衡

**负载均衡 :** 指将负载(工作任务)进行平衡, 分摊到多个操作单元上进行运行。

负载均衡基础配置

``` js
// 反向代理基础配置
upstream rtpserver {
    // 配置多态应用服务器地址
    server 21.96.51.223:8080 weight=1;
    server 21.96.51.224:8080 weight=1;
}
server {
    location / {
        // 配置对外地址
        proxy_pass http://rtpserver;
    }
}
```

###### 5种负载均衡方法

* 轮询(默认) : 按时间逐一分配到不同的后端服务器
* 加权轮训 : 可在配置的server后面加个weight=number; number值越高, 分配的概率越大。
* ip_hash : 每个请求按访问IP的hash分配, 这样来自同一IP固定访问一个后台服务器。
* least_conn : 最小链接数, 哪个机器连接数最少就分发给哪个机器
* url_hash : 按访问的url的hash结果分配请求, 是每个url定向到同一后端服务器上。

### web缓存

nginx将后端服务器index.html缓存到本地,在客户端需要访问首页时直接返回。 在一定程序上,减少了源服务器的处理请求压力。

配置web缓存

``` 